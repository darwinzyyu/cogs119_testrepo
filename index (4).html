<!DOCTYPE html>
<html>

<head>
  <title>Massive Memory Experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-slider-response@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>
  // Initialize jsPsych - setting up experiment global settings
  var jsPsych = initJsPsych({
    on_finish: function () {
      // Making sure experiment properly terminates (fullscreen exit and notifying participants)
      if (document.fullscreenElement) {
        document.exitFullscreen().then(() => {
          alert("Thank you for participating. The experiment has ended.");
          window.close(); // closing browser window
        }).catch(() => {
          alert("Thank you for participating. Please close this window manually.");
        });
      } else {
        alert("Thank you for participating. Please close this window manually.");
      }
    }
  });

  // Defining experiment timeline (sequential list of tasks and trials)
  var timeline = [];

  // URL fetching JSON file containing experimental stimuli (images & metadata)
  var gist_url = 'https://raw.githubusercontent.com/SyeinW/cogs119_testrepo/patch-1/stimuli_pairs.json';

  // Fetch stimuli data & configure experiment
  fetch(gist_url)
    .then(response => response.json())
    .then(data => {

      // Extract all image paths from data for preloading
      let image_list = [];
      data.forEach(item => {
        image_list.push(item.image1, item.image2);
      });

      // Preload images 
      timeline.push({
        type: jsPsychPreload,
        images: image_list
      });

      // Randomizing image order
      var count = 0
      var shuffled_images = jsPsych.randomization.shuffle(data);

      function create4BackSequence(imagePool) {
        // Constants for our specific requirements
        const BASE_IMAGES = 150;    // Base unique images
        const REPEATS = 20;         // Number of 4-back repeats
        const TOTAL_IMAGES = 170;   // Final sequence length

        // Validate we have enough images
        if (imagePool.length < BASE_IMAGES) {
          throw new Error(`Need at least ${BASE_IMAGES} images, but only ${imagePool.length} provided`);
        }

        // Randomly select 20 positions where we will create 4-back repeats
        // We can only select positions 0 through 145 since we need room for the 4-back
        const possiblePositions = Array.from({ length: 146 }, (_, i) => i);
        const selectedPositions = jsPsych.randomization.sampleWithoutReplacement(possiblePositions, REPEATS);

        // Sort positions so we insert from left to right
        selectedPositions.sort((a, b) => a - b);

        // For each selected position, insert its image again 4 positions later
        selectedPositions.forEach(position => {
          const imageToRepeat = shuffled_images[position];
          shuffled_images.splice(position + 4, 0, imageToRepeat);
        });

        // Verify the sequence
        console.log(`Sequence length: ${shuffled_images.length}`);
        let repeatCount = 0;
        for (let i = 4; i < shuffled_images.length - 4; i++) {
          if (shuffled_images[i] === shuffled_images[i - 4]) {
            repeatCount++;
            console.log(`4-back match found at positions ${i - 4} and ${i}: ${shuffled_images[i]}`);
          }
        }
        console.log(`Total 4-back repeats: ${repeatCount}`);

        return shuffled_images;
      }

      const experimentSequence = create4BackSequence(shuffled_images);

      // stores images used in current round of studying
      // If we are separating by each session move this into for loop
      // iterate through each picture and add them to the study session and testing session
      shuffled_images.forEach(item => {

        // Add fixation cross and memory image display for each image in memory phase
        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '<div style="font-size:60px;">+</div>', // Fixation cross
          choices: "NO_KEYS",
          trial_duration: 500,
        });

        // counterbalancing strategy. 50% for image 1 of the image set to be chosen and 50% for image 2 of the image set to be chosen
        var counterbalancing;
        if (Math.random() < .5) {
          counterbalancing = item.image1;
        } else {
          counterbalancing = item.image2;
        }

        timeline.push({
          type: jsPsychImageKeyboardResponse,
          stimulus: counterbalancing, // Displaying memory image
          choices: "NO_KEYS",
          trial_duration: 500,
        });

        count++;
        if (count > 50) {
          timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: "Are you still there?",
            choices: ["Yes", "No"],
          });
          count = 0;
        }
      });

      // Running experiment with configured timeline
      jsPsych.run(timeline);
    });

</script>

</html>