<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    }
  });

  /* create timeline */
  var timeline = [];

  /**
   * enable fullscreen
   */
  timeline.push({
    type: jsPsychFullscreen,
    fullscreen_mode: true
  });

  //Create a random ID for the participant
  var participant_id = jsPsych.randomization.randomID();
  jsPsych.data.addProperties({
    participant: participant_id
  });
  console.log("Generated Participant ID:", participant_id);

  // define welcome message trial
  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "Welcome to the experiment. Press any key to continue."
  };

  // add the welcome trial to the timeline variable
  timeline.push(welcome);

  // Tell the participants how the experiment will work
  var instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
  <p>You will be shown X images in a series</p>
  <p>After you see all the images, you will be shown pairs of images.</p>
  <p>Select the image you think you saw during the intial stream of images</p>
  <p>Press any key to begin.</p>
  `
  };

  //add the instructions trial to the timeline
  timeline.push(instructions);

  /* create memory list */
  // create a list of all items to be tested during the memory procedure
  // TO DO: how can we expand this list to encompass all items?
  // TO DO: How can we randomize which of the state/ exemplar items are studied?
  var memory_list = [
    "stimuli/STATE/USED/Sabacus1.jpg",
    "stimuli/STATE/USED/Sbabytoy1.JPG",
    "stimuli/STATE/USED/Sbagel1.JPG",
    "stimuli/EXEMPLAR/USED/Ebasket1.jpg",
    "stimuli/EXEMPLAR/USED/Ebell1.jpg",
    "stimuli/EXEMPLAR/USED/Ebicycle1.jpg"
  ]
  //shuffle
  var memory_list_shuffled = jsPsych.randomization.shuffle(memory_list);
  console.log(memory_list_shuffled)

  /* create test stimulus list */
  // create a list of images to use at test
  // TO DO: how can we expand this list to encompass all items?
  var test_list = [
    {
      item_1: "Sabacus1.jpg",
      item_2: "Sabacus2.jpg",
      test_type: "state",
      // store the stimulus path here, relative to the index.html
      path_to_image: "stimuli/STATE/USED/"
    },
    {
      item_1: "Sbabytoy1.JPG",
      item_2: "Sbabytoy2.JPG",
      test_type: "state",
      path_to_image: "stimuli/STATE/USED/"
    },
    {
      item_1: "Sbagel1.JPG",
      item_2: "Sbagel2.jpg",
      test_type: "state",
      path_to_image: "stimuli/STATE/USED/"
    },
    {
      item_1: "Ebasket1.jpg",
      item_2: "Ebasket2.jpg",
      test_type: "exemplar",
      path_to_image: "stimuli/EXEMPLAR/USED/"
    },
    {
      item_1: "Ebell1.jpg",
      item_2: "Ebell2.jpg",
      test_type: "exemplar",
      path_to_image: "stimuli/EXEMPLAR/USED/"
    },
    {
      item_1: "Ebicycle1.jpg",
      item_2: "Ebicycle2.jpg",
      test_type: "exemplar",
      path_to_image: "stimuli/EXEMPLAR/USED/"
    }
  ];
  //shuffle
  var test_list_shuffled = jsPsych.randomization.shuffle(test_list);
  console.log(test_list_shuffled)

  //cycle through memory list using a for loop
  for (i = 0; i < memory_list_shuffled.length; i++) {

    //select the current image item
    var current_image = memory_list_shuffled[i];

    //add fixation cross
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 1000,
    };

    timeline.push(fixation);

    // here's how we can construct a simple image trial
    // TO DO: add repeated trials
    // what else do we need to add to the trial procedure? What other information should we store? How can we turn this into a complete experiment timeline?
    var trial = {
      type: jsPsychImageKeyboardResponse,
      stimulus: current_image,
      //make the space bar a response option
      choices: [" "],
      //the stimulus is shown for 3000 ms
      trial_duration: 3000,
      //response should not end trial so that we can keep the same consistent presentation timing
      response_ends_trial: false,
      data: {
        trial_phase: "memory"
      }
    }
    //push the trial to the timeline
    timeline.push(trial);
  }

  //cycle through test list using a for loop
  for (let i = 0; i < test_list_shuffled.length; i++) {
    var current_item = test_list_shuffled[i];
    var image_1 = current_item["path_to_image"] + current_item["item_1"];
    var image_2 = current_item["path_to_image"] + current_item["item_2"];
    var shuffledImages = jsPsych.randomization.shuffle([image_1, image_2]);

    // Test trial with shuffled images and data tracking for feedback
    var test_trial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "Which of these items did you see before?",
      choices: [
        `<img src="${shuffledImages[0]}" style="width:200px;height:200px;">`,
        `<img src="${shuffledImages[1]}" style="width:200px;height:200px;">`
      ],
      data: {
        choice_images: shuffledImages,
        correct_image: image_1  // Assuming image_1 is always the correct "old" item
      },
      on_finish: function (data) {
        data.choice = data.choice_images[data.response];
        data.correct = data.choice === data.correct_image;
      }
    };

    var feedback = {
      type: jsPsychHtmlKeyboardResponse,
      trial_duration: 1000,
      stimulus: function () {
        var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
        return last_trial_correct ? "<p>Correct!</p>" : "<p>Incorrect. Let's try again.</p>";
      },
      post_trial_gap: 500,
      response_ends_trial: false
    };

    // Repeat trial until correct
    var repeat_trial = {
      timeline: [test_trial, feedback],
      loop_function: function () {
        var last_trial_correct = jsPsych.data.get().last(2).values()[0].correct;
        return !last_trial_correct;  // Repeat only if incorrect
      }
    };

    // Push only the repeat_trial to the timeline
    timeline.push(repeat_trial);
  }

  // Post-experiment survey for participant confidence and feedback
  var post_experiment_survey = {
    type: jsPsychSurveyText,
    questions: [
      {
        prompt: "How confident are you in your overall performance during the experiment? (e.g., very confident, somewhat confident, not confident)",
        placeholder: "Type your confidence level here...",
        rows: 3,
        columns: 50
      },
      {
        prompt: "What details did you use to distinguish the items you saw before from the new items? Please describe.",
        placeholder: "Type your response here...",
        rows: 5,
        columns: 50
      }
    ],
    preamble: "<h3>Post-Experiment Survey</h3><p>Please answer the following questions about your experience during the experiment.</p>",
    button_label: "Submit"
  };

  // Add the survey to the timeline
  timeline.push(post_experiment_survey);

  var end_experiment = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "the experiment has ended, press any key to exit. Goodbye!"
  };
  timeline.push(end_experiment);


  /**
   * Disable full screen 
   */
  timeline.push({
    type: jsPsychFullscreen,
    fullscreen_mode: false
  });

  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>